<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã€å—ä»˜ç”¨ã€‘QRãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; background: #333; color: white; margin: 0; padding: 20px; }
    #canvas { width: 100%; max-width: 400px; border: 2px solid #fff; border-radius: 10px; }
    .status-msg { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1.2em; }
    .success { background: #28a745; }
    .error { background: #e53e3e; }
    .loading { background: #4a5568; }
    #result-info { margin-top: 20px; text-align: left; background: #fff; color: #333; padding: 15px; border-radius: 8px; display: none; }
  </style>
</head>
<body>
  <h1>ğŸŸï¸ å—ä»˜ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</h1>
  <p>ã‚«ãƒ¡ãƒ©ã‚’QRã‚³ãƒ¼ãƒ‰ã«å‘ã‘ã¦ãã ã•ã„</p>
  
  <canvas id="canvas" hidden></canvas>
  <div id="loadingMessage">ğŸ¥ ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...</div>
  <div id="status" class="status-msg loading">å¾…æ©Ÿä¸­</div>

  <div id="result-info">
    <h2 id="res-name"></h2>
    <p id="res-id"></p>
    <p id="res-ticket"></p>
  </div>

  <button onclick="location.reload()" style="margin-top:30px; padding:15px; width:100%; max-width:400px; font-size:18px; border-radius:10px; border:none; background:#007bff; color:white; cursor:pointer;">æ¬¡ã®äººã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>

  <script>
    const video = document.createElement("video");
    const canvasElement = document.getElementById("canvas");
    const canvas = canvasElement.getContext("2d");
    const loadingMessage = document.getElementById("loadingMessage");
    const statusDiv = document.getElementById("status");
    const resultDiv = document.getElementById("result-info");
    
    const url = "https://script.google.com/macros/s/AKfycbxupXS-myDaS5LNN8ouX0GCYKGflVacLC6fNs16tMJvEuH_N0XQAAOgjnlEZKl7NfQeqQ/exec"; // â˜…admin.jsã¨åŒã˜URLã‚’è²¼ã‚‹//

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
      video.srcObject = stream;
      video.setAttribute("playsinline", true);
      video.play();
      requestAnimationFrame(tick);
    });

    function tick() {
      loadingMessage.innerText = "âŒ› èª­ã¿è¾¼ã¿ä¸­...";
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        loadingMessage.hidden = true;
        canvasElement.hidden = false;
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        
        const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

        if (code) {
          checkIn(code.data); // QRã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‡¦ç†ã¸
          return; // ä¸€æ—¦åœæ­¢
        }
      }
      requestAnimationFrame(tick);
    }

   async function checkIn(qrData) {
  const statusDiv = document.getElementById("status");
  const resultDiv = document.getElementById("result-info");
  
  if (statusDiv.innerText === "ğŸ”„ ç…§åˆä¸­...") return;
  statusDiv.innerText = "ğŸ”„ ç…§åˆä¸­...";
  statusDiv.className = "status-msg loading";
  
  try {
    const res = await fetch(`${url}?type=checkin&id=${encodeURIComponent(qrData)}&t=${new Date().getTime()}`);
    const result = await res.json();

    if (result.status === "success") {
      statusDiv.innerText = "âœ… å…¥å ´OKï¼";
      statusDiv.className = "status-msg success";
      resultDiv.style.display = "block";
      
      // ãŠåå‰ã€å—ä»˜ç•ªå·ã€åˆ¸ç¨®ã‚’ã‚ã‹ã‚Šã‚„ã™ãè¡¨ç¤º
      document.getElementById("res-name").innerText = result.name + " æ§˜";
      document.getElementById("res-id").innerText = "å—ä»˜ç•ªå·ï¼š" + result.id;
      document.getElementById("res-ticket").innerText = result.ticket;
      
    } else {
      statusDiv.innerText = "âŒ " + result.message;
      statusDiv.className = "status-msg error";
      resultDiv.style.display = "none";
    }
  } catch (error) {
    statusDiv.innerText = "âŒ é€šä¿¡å¤±æ•—";
    statusDiv.className = "status-msg error";
  }
}
  </script>
</body>
</html>